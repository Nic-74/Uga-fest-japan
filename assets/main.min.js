/* Header menu */
const menuBtn=document.querySelector(".menu-btn"),menu=document.getElementById("menu");if(menuBtn){menuBtn.addEventListener("click",()=>{const o=menu.classList.toggle("open");menuBtn.setAttribute("aria-expanded",o?"true":"false")})}
/* Active nav link */
document.querySelectorAll("nav a").forEach(a=>{const href=a.getAttribute("href")||"",path=location.pathname.split("/").pop()||"index.html";if(href===path){a.setAttribute("aria-current","page");a.classList.add("active")}});
/* FAQs */
document.querySelectorAll(".faq-q").forEach(q=>{q.addEventListener("click",()=>{const a=q.parentElement.querySelector(".faq-a"),o=a.style.display==="block";a.style.display=o?"none":"block";q.setAttribute("aria-expanded",o?"false":"true");q.lastElementChild.textContent=o?"+":"‚Äì"})});
/* Back to top */
const btt=document.getElementById("backToTop");if(btt){window.addEventListener("scroll",()=>{btt.style.display=window.scrollY>600?"block":"none"});btt.addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"}))}
/* Year */
const y=document.getElementById("year");if(y)y.textContent=(new Date).getFullYear();

/* === THEME SWITCHER (auto-injected button, remembers choice) === */
(function(){
  const KEY="theme";
  const prefersDark=()=>window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;
  const getTheme=()=>{const s=localStorage.getItem(KEY);return s==="light"||s==="dark"?s:(prefersDark()?"dark":"light")};
  const apply=t=>{document.documentElement.dataset.theme=t;document.documentElement.style.colorScheme=t};
  const set=t=>{localStorage.setItem(KEY,t);apply(t)};
  apply(getTheme());
  const cta=document.querySelector(".nav-cta");
  if(cta&&!document.getElementById("themeToggle")){
    const btn=document.createElement("button");
    btn.id="themeToggle";btn.type="button";btn.className="theme-toggle";btn.setAttribute("aria-pressed","false");
    const label=(t)=>t==="dark"?'<span class="ic">üåô</span><span>Dark</span>':'<span class="ic">‚òÄÔ∏è</span><span>Light</span>';
    const update=()=>{const t=document.documentElement.dataset.theme||getTheme();btn.innerHTML=label(t);btn.setAttribute("aria-pressed",t==="dark")};
    btn.addEventListener("click",()=>{const cur=document.documentElement.dataset.theme||getTheme();set(cur==="dark"?"light":"dark");update()});
    update();cta.appendChild(btn);
  }
})();

/* === Countdown (JST-safe, reads data-target) === */
(function(){const boxes=document.querySelectorAll(".countdown");if(!boxes.length)return;boxes.forEach(box=>{const dd=box.querySelector("#dd"),hh=box.querySelector("#hh"),mm=box.querySelector("#mm"),ss=box.querySelector("#ss");const iso=box.getAttribute("data-target")||"2025-10-12T00:00:00+09:00";let target=Date.parse(iso);if(Number.isNaN(target))target=Date.UTC(2025,9,11,15,0,0);const z=n=>String(n).padStart(2,"0");const tick=()=>{const now=Date.now();let diff=Math.max(0,target-now);const d=Math.floor(diff/86400000);diff-=d*86400000;const h=Math.floor(diff/3600000);diff-=h*3600000;const m=Math.floor(diff/60000);diff-=m*60000;const s=Math.floor(diff/1000);if(dd)dd.textContent=d;if(hh)hh.textContent=z(h);if(mm)mm.textContent=z(m);if(ss)ss.textContent=z(s);if(target-now<=0){box.setAttribute("aria-live","polite");box.title="Uga Fest is live!";clearInterval(timer)}};tick();const timer=setInterval(tick,1e3)})})();

/* === Add to Calendar (.ics) === */
const addCal=document.getElementById("addCal");if(addCal){addCal.addEventListener("click",()=>{const ics=[
"BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Uga Fest Japan//EN","BEGIN:VEVENT",
"UID:ugafest-2025-10-12@example",
"DTSTAMP:"+new Date().toISOString().replace(/[-:]/g,"").split(".")[0]+"Z",
"DTSTART;VALUE=DATE:20251012","DTEND;VALUE=DATE:20251013",
"SUMMARY:Uga Fest Japan 2025 ‚Äî Nagoya",
"LOCATION:Flow Jam Nagoya, Pivot Lion Building 404, 3-10-14 Sakae, Naka Ward, Nagoya 460-0008",
"DESCRIPTION:Celebrate Uganda‚Äôs Independence with sports, food, and live performances. Tickets: Ordinary ¬•10,000 / VIP ¬•20,000",
"END:VEVENT","END:VCALENDAR"
].join("\r\n");const blob=new Blob([ics],{type:"text/calendar"}),url=URL.createObjectURL(blob),a=document.createElement("a");a.href=url;a.download="ugafest-2025.ics";a.click();setTimeout(()=>URL.revokeObjectURL(url),1500)})}


/* Lock body scroll when mobile menu is open */
(function(){
  const btn=document.querySelector('.menu-btn'); const menu=document.getElementById('menu');
  if(!btn||!menu) return;
  const lock = (on)=>{ document.documentElement.style.overflow = on ? 'hidden' : ''; };
  btn.addEventListener('click', ()=>{ const open = menu.classList.contains('open'); lock(!open); });
  // Close menu on link tap
  menu.querySelectorAll('a').forEach(a=>a.addEventListener('click', ()=>{ menu.classList.remove('open'); lock(false); }));
})();

/* === LANGUAGE TOGGLE FUNCTIONALITY === */
(function() {
  // Load translations
  function loadTranslations(callback) {
    if (typeof translations !== 'undefined') {
      callback(translations);
      return;
    }
    
    // If translations aren't loaded, try to load them
    const script = document.createElement('script');
    script.src = 'assets/translations.js';
    script.onload = function() {
      callback(translations);
    };
    script.onerror = function() {
      console.error('Failed to load translations');
    };
    document.head.appendChild(script);
  }
  
  // Apply translation to the page
  function applyTranslation(lang) {
    loadTranslations(function(translations) {
      const translationData = translations[lang];
      
      // Translate all elements with data-translate attribute
      document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (translationData[key]) {
          element.textContent = translationData[key];
        }
      });
      
      // Translate input placeholders
      document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
        const key = element.getAttribute('data-translate-placeholder');
        if (translationData[key]) {
          element.setAttribute('placeholder', translationData[key]);
        }
      });
      
      // Translate button texts
      document.querySelectorAll('[data-translate-value]').forEach(element => {
        const key = element.getAttribute('data-translate-value');
        if (translationData[key]) {
          element.value = translationData[key];
        }
      });
      
      // Update language toggle button
      const toggleBtn = document.getElementById('languageToggle');
      if (toggleBtn) {
        if (lang === 'ja') {
          toggleBtn.innerHTML = '<span class="ic">üåê</span> EN';
          toggleBtn.setAttribute('aria-label', 'Switch to English');
        } else {
          toggleBtn.innerHTML = '<span class="ic">üåê</span> JA';
          toggleBtn.setAttribute('aria-label', 'Switch to Japanese');
        }
      }
      
      // Update HTML lang attribute
      document.documentElement.lang = lang;
      
      // Save language preference
      localStorage.setItem('preferredLanguage', lang);
    });
  }
  
  // Initialize language
  function initLanguage() {
    const savedLang = localStorage.getItem('preferredLanguage') || 'en';
    applyTranslation(savedLang);
    
    // Set up toggle button
    const toggleBtn = document.getElementById('languageToggle');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', function() {
        const currentLang = localStorage.getItem('preferredLanguage') || 'en';
        const newLang = currentLang === 'en' ? 'ja' : 'en';
        applyTranslation(newLang);
      });
    }
  }
  
  // Run when DOM is loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLanguage);
  } else {
    initLanguage();
  }
})();
